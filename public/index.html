<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Microcosmo: Evolu√ß√£o</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
	<script src="/socket.io/socket.io.js"></script>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --canvas-bg: #ffffff;
            --text-color: #333;
            --arrow-color: rgba(0, 0, 0, 0.4);
            --panel-bg: rgba(255, 255, 255, 0.7);
            --panel-border: rgba(0, 0, 0, 0.1);
        }
        body.dark-theme {
            --bg-color: #1a202c;
            --canvas-bg: #2d3748;
            --text-color: #edf2f7;
            --arrow-color: rgba(255, 255, 255, 0.5);
            --panel-bg: rgba(45, 55, 72, 0.7);
            --panel-border: rgba(255, 255, 255, 0.1);
        }
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Impede a rolagem */
        }
        body {
            font-family: 'Orbitron', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        canvas {
            display: block;
            background-color: var(--canvas-bg);
            cursor: none;
            width: 100%;
            height: 100%;
            transition: background-color 0.3s;
        }
        #startScreen, #gameOverScreen, #settingsPanel, #pauseScreen {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        body.dark-theme #startScreen, body.dark-theme #gameOverScreen, body.dark-theme #settingsPanel, body.dark-theme #pauseScreen {
             background: rgba(26, 32, 44, 0.8);
        }
        .ui-panel {
            background: var(--panel-bg);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid var(--panel-border);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .hidden {
            display: none !important;
        }
        .title-text {
            color: var(--text-color);
        }
        .simple-button {
            background-color: #007bff;
            color: #fff;
            transition: background-color 0.3s ease;
        }
        .simple-button:hover {
            background-color: #0056b3;
        }
        #mobileControls {
            display: none; 
        }
        .mobile-visible {
            display: flex !important;
        }
        @media (max-width: 640px) and (orientation: portrait) {
            #leaderboard { padding: 0.4rem; width: 100px; font-size: 0.65rem; }
            #leaderboard .text-lg { font-size: 0.8rem; margin-bottom: 0.2rem; }
        }
        @media (max-height: 500px) and (orientation: landscape) {
            #leaderboard { padding: 0.2rem 0.5rem; width: 110px; font-size: 0.6rem; }
            #leaderboard .text-lg { font-size: 0.7rem; margin-bottom: 0.1rem; }
            .action-button { width: 48px; height: 48px; font-size: 1.2rem; }
            #mobileControls { gap: 0.75rem; }
        }
        .action-button {
            width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.5rem; color: white; box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.5); -webkit-tap-highlight-color: transparent;
        }
        #skinPreview {
            width: 80px; height: 80px; border-radius: 50%; border: 2px dashed #ccc; margin-top: 1rem;
            background-size: cover; background-position: center; background-color: #e9e9e9; cursor: pointer;
        }
        #theme-toggle, #settingsButton {
            position: absolute; top: 1rem; width: 40px; height: 40px; border-radius: 50%; font-size: 1.5rem;
            border: 1px solid var(--panel-border); background-color: var(--panel-bg); z-index: 21;
        }
        #theme-toggle { left: 1rem; }
        #settingsButton { right: 1rem; }
        #minimapCanvas {
            position: absolute; top: 1rem; left: 1rem; width: 150px; height: 150px;
            border: 2px solid var(--panel-border); background-color: var(--panel-bg); border-radius: 8px; z-index: 10;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Bot√µes Globais -->
    <button id="theme-toggle">üåô</button>
    <button id="settingsButton">‚öôÔ∏è</button>

    <!-- Painel de Configura√ß√µes -->
    <div id="settingsPanel" class="absolute inset-0 z-30 flex flex-col items-center justify-center transition-opacity duration-500 hidden">
        <div class="text-center p-8 ui-panel w-11/12 max-w-md">
            <h2 class="text-3xl font-bold title-text mb-6">Configura√ß√µes</h2>
            <div class="flex items-center justify-center space-x-4 text-lg">
                <label for="toggleMinimap" class="font-semibold title-text">Ativar Minimapa</label>
                <input type="checkbox" id="toggleMinimap" class="h-6 w-6 accent-blue-500">
            </div>
            <button id="closeSettingsButton" class="mt-8 font-bold rounded-lg px-8 py-3 text-lg transform hover:scale-105 w-full bg-gray-500 text-white">FECHAR</button>
        </div>
    </div>

    <!-- Tela de Pausa -->
    <div id="pauseScreen" class="absolute inset-0 z-40 flex flex-col items-center justify-center transition-opacity duration-500 hidden">
        <div class="text-center p-8 ui-panel w-11/12 max-w-md">
            <h1 class="text-5xl font-bold title-text mb-8">PAUSADO</h1>
            <button id="resumeButton" class="font-bold rounded-lg px-8 py-3 text-lg transform hover:scale-105 w-full simple-button">RETORNAR</button>
        </div>
    </div>

    <!-- Tela de In√≠cio -->
    <div id="startScreen" class="absolute inset-0 z-20 flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="text-center p-8 sm:p-12 ui-panel w-11/12 max-w-2xl">
            <h1 class="text-5xl sm:text-7xl font-bold title-text mb-2">MICROCOSMO</h1>
            <p class="text-lg text-gray-600 mb-4">W para doar, Espa√ßo para dividir</p>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-center">
                <div><input type="text" id="playerNameInput" placeholder="Seu Nome" class="bg-gray-100 text-gray-800 placeholder-gray-500 border-2 border-gray-300 rounded-lg px-4 py-3 text-center focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all w-full"></div>
                <div class="flex flex-col items-center">
                    <div id="skinPreview" title="Clique para escolher uma skin"></div>
                    <input type="file" id="skinInput" accept="image/*" class="hidden">
                </div>
            </div>
            <button id="startButton" class="mt-6 font-bold rounded-lg px-8 py-3 text-lg transform hover:scale-105 w-full simple-button">INICIAR JOGO</button>
        </div>
    </div>

    <!-- UI do Jogo -->
    <div id="leaderboard" class="absolute top-4 right-4 z-10 p-4 ui-panel hidden w-48 sm:w-64">
        <h2 class="text-lg font-bold text-center mb-2">Top 5</h2>
        <ol id="leaderboardList" class="list-decimal list-inside"></ol>
    </div>
    <div id="xpBarContainer" class="absolute bottom-4 left-1/2 -translate-x-1/2 z-10 w-1/3 hidden">
        <div class="text-center text-white font-bold mb-1" style="text-shadow: 1px 1px 2px black;">
            <span id="levelText">N√≠vel 1</span>
        </div>
        <div class="w-full bg-gray-700 rounded-full h-4 border-2 border-gray-500">
            <div id="xpBarFill" class="bg-yellow-400 h-full rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
    </div>
    
    <!-- Controles Mobile -->
    <div id="mobileControls" class="absolute right-4 bottom-4 z-20 flex flex-col gap-4">
        <button id="donateButton" class="action-button bg-yellow-500">W</button>
        <button id="splitButton" class="action-button bg-blue-500 text-2xl">‚ûó</button>
    </div>

    <!-- Tela de Fim de Jogo -->
    <div id="gameOverScreen" class="absolute inset-0 z-20 flex flex-col items-center justify-center transition-opacity duration-500 hidden">
         <div class="text-center p-8 rounded-2xl ui-panel">
            <h1 class="text-6xl font-bold text-red-600 mb-4">FIM DE JOGO</h1>
            <p class="text-2xl mb-2">Massa final:</p>
            <p id="finalScore" class="text-5xl font-bold text-blue-600 mb-8">0</p>
            <div class="flex gap-4">
                <button id="restartButton" class="font-bold rounded-lg px-8 py-3 text-lg transform hover:scale-105 simple-button">TENTAR NOVAMENTE</button>
                <button id="menuButton" class="font-bold rounded-lg px-8 py-3 text-lg transform hover:scale-105 bg-gray-500 text-white">MENU</button>
            </div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>
    <canvas id="minimapCanvas" class="hidden"></canvas>

    <script>
        // Cole isso na sua tag <script>

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
// ... (pegue todos os outros elementos da UI como voc√™ j√° faz)

// Conecta com o servidor
const socket = io();
let serverState = { players: {}, food: [] };
let myId = null;
let animationFrameId;

// --- L√≥gica de Conex√£o ---
socket.on('connect', () => {
    myId = socket.id;
    console.log('Conectado ao servidor com o ID:', myId);
});

// Recebe o estado do jogo do servidor e guarda
socket.on('gameState', (state) => {
    serverState = state;
});


// --- Fun√ß√µes Principais ---
function init() {
    // L√≥gica para esconder menus e mostrar o jogo
    ui.startScreen.classList.add('hidden');
    ui.leaderboard.classList.remove('hidden');
    // ... etc

    // Avisa o servidor que voc√™ est√° pronto para come√ßar
    socket.emit('startGame', {
        name: ui.playerNameInput.value.trim() || 'An√¥nimo'
    });

    if (animationFrameId) cancelAnimationFrame(animationFrameId);
    animate();
}

function animate() {
    animationFrameId = requestAnimationFrame(animate);

    if (!myId || !serverState.players[myId]) return; // Espera ter um estado v√°lido

    // Envia a dire√ß√£o do mouse para o servidor
    const direction = getPlayerDirection();
    socket.emit('playerInput', direction);

    // Limpa a tela
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // --- L√≥gica de C√¢mera ---
    const me = serverState.players[myId];
    ctx.save();
    ctx.translate(canvas.width / 2, canvas.height / 2);
    // O zoom pode ser calculado com base no raio do seu jogador
    const zoom = 200 / (me.radius + 100);
    ctx.scale(zoom, zoom);
    ctx.translate(-me.x, -me.y);


    // --- Desenho (Renderiza√ß√£o) ---
    // Apenas desenha o que o servidor manda
    serverState.food.forEach(f => {
        ctx.beginPath();
        ctx.arc(f.x, f.y, f.radius, 0, Math.PI * 2);
        ctx.fillStyle = f.color;
        ctx.fill();
    });

    for (const id in serverState.players) {
        const player = serverState.players[id];
        ctx.beginPath();
        ctx.arc(player.x, player.y, player.radius, 0, Math.PI * 2);
        ctx.fillStyle = player.color;
        ctx.fill();

        ctx.fillStyle = '#FFFFFF';
        ctx.font = 'bold 16px Orbitron';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(player.name, player.x, player.y);
    }

    ctx.restore();
}

// A fun√ß√£o getPlayerDirection continua igual, pois √© do lado do cliente
function getPlayerDirection() {
    let angle = 0, magnitude = 0;
    const dx = mouse.x - window.innerWidth / 2;
    const dy = mouse.y - window.innerHeight / 2;
    angle = Math.atan2(dy, dx);
    if (dx !== 0 || dy !== 0) magnitude = 1;
    return { angle, magnitude };
}

// O resto do seu c√≥digo (setupEventListeners, etc.) precisa ser adaptado.
// O bot√£o de start agora chama a nossa nova fun√ß√£o `init`.
ui.startButton.addEventListener('click', init);
// ... outros listeners
window.addEventListener('mousemove', (e) => { mouse.x = e.clientX; mouse.y = e.clientY; });	

    </script>
</body>
</html>
